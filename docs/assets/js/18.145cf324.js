(window.webpackJsonp=window.webpackJsonp||[]).push([[18],{442:function(e,t,a){"use strict";a.r(t);var o=a(62),s=Object(o.a)({},(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("ul",[a("li",[e._v("Title: Logging")]),e._v(" "),a("li",[e._v("Start Date: 2021-04-21")]),e._v(" "),a("li",[e._v("Specification PR: "),a("a",{attrs:{href:"https://github.com/meilisearch/specifications/pull/33",target:"_blank",rel:"noopener noreferrer"}},[e._v("#33"),a("OutboundLink")],1)]),e._v(" "),a("li",[e._v("MeiliSearch Tracking-issues: "),a("a",{attrs:{href:"https://github.com/meilisearch/transplant/issues/193",target:"_blank",rel:"noopener noreferrer"}},[e._v("transplant/#193"),a("OutboundLink")],1)])]),e._v(" "),a("h1",{attrs:{id:"logging"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#logging"}},[e._v("#")]),e._v(" Logging")]),e._v(" "),a("h2",{attrs:{id:"_1-functional-specification"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-functional-specification"}},[e._v("#")]),e._v(" 1. Functional Specification")]),e._v(" "),a("h3",{attrs:{id:"i-summary"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#i-summary"}},[e._v("#")]),e._v(" I. Summary")]),e._v(" "),a("p",[e._v("As a user of the MeiliSearch binary, I want to be able to know what is happening in the engine at different levels of granularity depending on my needs.")]),e._v(" "),a("h3",{attrs:{id:"ii-motivation"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ii-motivation"}},[e._v("#")]),e._v(" II. Motivation")]),e._v(" "),a("p",[e._v("Keeping track of the behavior of a system is useful for those who test, develop and use it in production. The purpose of this specification is to indicate the logging behavior of the search engine.")]),e._v(" "),a("h3",{attrs:{id:"iii-additional-materials"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#iii-additional-materials"}},[e._v("#")]),e._v(" III. Additional Materials")]),e._v(" "),a("h4",{attrs:{id:"algolia"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#algolia"}},[e._v("#")]),e._v(" Algolia")]),e._v(" "),a("p",[e._v("Algolia offers an API endpoint dedicated to retrieving the logs of search and indexing operations.")]),e._v(" "),a("blockquote",[a("p",[e._v("A call on the "),a("code",[e._v("getLogs")]),e._v(" endpoint affect the algolia quota but it is not counted as a log.")]),e._v(" "),a("p",[e._v("The logs are kept for a period of 7 days. After this period, they are no longer accessible from the API.")])]),e._v(" "),a("p",[e._v("Algolia gives parameters to modify the request according to the user's needs.")]),e._v(" "),a("blockquote",[a("p",[e._v("A query performed without parameters returns the last 10 records by default.")]),e._v(" "),a("p",[e._v("The maximum number of logs that can be returned per request is 1000.")])]),e._v(" "),a("p",[e._v("It is possible to use the "),a("code",[e._v("offset")]),e._v(" and "),a("code",[e._v("length")]),e._v(" parameters to search the log entries.")]),e._v(" "),a("p",[e._v("A "),a("code",[e._v("type")]),e._v(" parameter is also provided to select the type of log to retrieve.")]),e._v(" "),a("table",[a("thead",[a("tr",[a("th",[e._v("Value")]),e._v(" "),a("th",[e._v("Description")])])]),e._v(" "),a("tbody",[a("tr",[a("td",[e._v("all")]),e._v(" "),a("td",[e._v("All the logs")])]),e._v(" "),a("tr",[a("td",[e._v("query")]),e._v(" "),a("td",[e._v("Exclusively the queries")])]),e._v(" "),a("tr",[a("td",[e._v("build")]),e._v(" "),a("td",[e._v("Exclusively the build operations")])]),e._v(" "),a("tr",[a("td",[e._v("error")]),e._v(" "),a("td",[e._v("Exclusively the errors")])])])]),e._v(" "),a("p",[e._v("Here is the information that Algolia chooses to return:")]),e._v(" "),a("table",[a("thead",[a("tr",[a("th",[e._v("Key")]),e._v(" "),a("th",[e._v("Description")])])]),e._v(" "),a("tbody",[a("tr",[a("td",[e._v("timestamp")]),e._v(" "),a("td",[e._v("Timestamp in ISO-8601 format")])]),e._v(" "),a("tr",[a("td",[e._v("method")]),e._v(" "),a("td",[e._v("Rest type of the method")])]),e._v(" "),a("tr",[a("td",[e._v("answer_code")]),e._v(" "),a("td",[e._v("HTTP response code")])]),e._v(" "),a("tr",[a("td",[e._v("query_body")]),e._v(" "),a("td",[e._v("Request body. Limited to 1000 characters")])]),e._v(" "),a("tr",[a("td",[e._v("answer")]),e._v(" "),a("td",[e._v("Answer body. Limited to 1000 characters")])]),e._v(" "),a("tr",[a("td",[e._v("url")]),e._v(" "),a("td",[e._v("Request URL")])]),e._v(" "),a("tr",[a("td",[e._v("ip")]),e._v(" "),a("td",[e._v("Client ip of the call")])]),e._v(" "),a("tr",[a("td",[e._v("query_headers")]),e._v(" "),a("td",[e._v("Request Headers (API Key is obfuscated)")])]),e._v(" "),a("tr",[a("td",[e._v("sha1")]),e._v(" "),a("td",[e._v("Id of log entry")])]),e._v(" "),a("tr",[a("td",[e._v("nb_api_calls")]),e._v(" "),a("td",[e._v("Number of API calls")])]),e._v(" "),a("tr",[a("td",[e._v("processing_time_ms")]),e._v(" "),a("td",[e._v("Processing time for the query (Does not include network time)")])]),e._v(" "),a("tr",[a("td",[e._v("query_nb_hits")]),e._v(" "),a("td",[e._v("Number of hits returned for the query")])]),e._v(" "),a("tr",[a("td",[e._v("exhaustive")]),e._v(" "),a("td",[e._v("Exhaustive flags used during the query")])]),e._v(" "),a("tr",[a("td",[e._v("index")]),e._v(" "),a("td",[e._v("Index name of the log")])]),e._v(" "),a("tr",[a("td",[e._v("inner_queries")]),e._v(" "),a("td",[e._v("Contains an object for each performed query with the "),a("code",[e._v("indexName")]),e._v(", "),a("code",[e._v("queryID")]),e._v(", "),a("code",[e._v("offset")]),e._v(", and "),a("code",[e._v("userToken")])])])])]),e._v(" "),a("blockquote",[a("p",[e._v("Source: "),a("em",[a("strong",[a("a",{attrs:{href:"https://www.algolia.com/doc/api-reference/api-methods/get-logs/",target:"_blank",rel:"noopener noreferrer"}},[e._v("Algolia documentation"),a("OutboundLink")],1)])])])]),e._v(" "),a("h4",{attrs:{id:"typesense"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#typesense"}},[e._v("#")]),e._v(" TypeSense")]),e._v(" "),a("p",[e._v("TypeSense makes no mention of logs in its documentation. However, the tracing policy seems to be in verbose mode and gives a lot of more or less relevant information.")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("typesense_1     | I20210403 01:06:33.688689     1 typesense_server_utils.cpp:301] Starting Typesense 0.19.0\ntypesense_1     | I20210403 01:06:33.690609     1 typesense_server_utils.cpp:304] Typesense is using jemalloc.\ntypesense_1     | I20210403 01:06:33.730222     1 typesense_server_utils.cpp:405] Starting API service...\ntypesense_1     | I20210403 01:06:33.730813    82 typesense_server_utils.cpp:210] Since no --nodes argument is provided, starting a single node Typesense cluster.\ntypesense_1     | I20210403 01:06:33.734120     1 http_server.cpp:189] Typesense has started listening on port 8108\ntypesense_1     | I20210403 01:06:33.744827    82 server.cpp:1045] Server[braft::RaftStatImpl+braft::FileServiceImpl+braft::RaftServiceImpl+braft::CliServiceImpl] is serving on port=8107.\ntypesense_1     | I20210403 01:06:33.744860    82 server.cpp:1048] Check out http://1c913ea63cb1:8107 in web browser.\ntypesense_1     | I20210403 01:06:33.747742    82 log.cpp:674] Use crc32c as the checksum type of appending entries\ntypesense_1     | I20210403 01:06:33.747857    82 log.cpp:1158] log load_meta /data/state/log/log_meta first_log_index: 1 time: 56\ntypesense_1     | I20210403 01:06:33.748559    82 log.cpp:1098] load open segment, path: /data/state/log first_index: 1\ntypesense_1     | I20210403 01:06:33.748966    82 raft_meta.cpp:521] Loaded single stable meta, path /data/state/meta term 3 votedfor 0.0.0.0:8107:8108 time: 193\n")])])]),a("p",[e._v("It also gives the stack trace in case of exception.")]),e._v(" "),a("h4",{attrs:{id:"elasticsearch"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#elasticsearch"}},[e._v("#")]),e._v(" ElasticSearch")]),e._v(" "),a("p",[e._v("Elasticsearch is probably the most versatile search engine when it comes to logging. "),a("a",{attrs:{href:"https://www.elastic.co/guide/en/elasticsearch/reference/current/logging.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("See the documentation"),a("OutboundLink")],1),e._v(".")]),e._v(" "),a("p",[e._v("It is possible to define a precise rolling log strategy.")]),e._v(" "),a("p",[e._v("A rolling log strategy permits to:")]),e._v(" "),a("ul",[a("li",[e._v("Facilitate the administration of systems that generate a large number of logs.")]),e._v(" "),a("li",[e._v("automates swapping, compressing, deleting, and sending logs. It assists in keeping the logging system within the specified file system space limits.")]),e._v(" "),a("li",[e._v("Defines an interval over which log analysis can be performed")]),e._v(" "),a("li",[e._v("Gives an efficient way to identify log files that are no longer used so that an automated process can clean up and compress the log directory and run log analysis programs.")])]),e._v(" "),a("p",[a("a",{attrs:{href:"https://en.wikipedia.org/wiki/Log_rotation",target:"_blank",rel:"noopener noreferrer"}},[e._v("See more information here about log rotation strategy"),a("OutboundLink")],1)]),e._v(" "),a("p",[e._v("This is an important thing to have when systems generate a lot of logs or are under heavy load. It's also a good practice to populate a monitoring dashboard at certain times and, through that, provide an easy way to analyze and understand what happened in the system in a human-readable way.")]),e._v(" "),a("p",[e._v("Internally, Elasticsearch uses "),a("code",[e._v("log4j2")]),e._v(" to track events and configure the logging policy. Logging levels can be configured on a per-package basis, giving the precision needed to monitor a specific feature or time in a search engine's lifecycle.")]),e._v(" "),a("p",[e._v("A log level can be: "),a("code",[e._v("debug")]),e._v(", "),a("code",[e._v("info")]),e._v(", "),a("code",[e._v("warn")]),e._v(", "),a("code",[e._v("error")]),e._v(", "),a("code",[e._v("fatal")]),e._v(", or "),a("code",[e._v("unknown")]),e._v(".")]),e._v(" "),a("h4",{attrs:{id:"elastic-entreprise-search"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#elastic-entreprise-search"}},[e._v("#")]),e._v(" Elastic Entreprise Search")]),e._v(" "),a("p",[e._v("Elasticsearch's SaaS platform, like Algolia, offers a fairly similar endpoint for browsing system-generated logs.")]),e._v(" "),a("p",[e._v("However, it is possible to disable log storage, change the retention period and also filter the logs with more details.")]),e._v(" "),a("p",[a("img",{attrs:{src:"https://www.elastic.co/guide/en/app-search/current/images/guides/log-settings-controls.png",alt:"image"}}),e._v(" "),a("em",[e._v("Elastic App Search's Log Retention settings view.")])]),e._v(" "),a("blockquote",[a("p",[e._v("It is also possible to do that from a Log Settings API endpoint.")])]),e._v(" "),a("blockquote",[a("p",[e._v("API Logs track requests and responses at the engine level, while Analytics Logs track requests, clicks and counts.")])]),e._v(" "),a("h3",{attrs:{id:"iv-explanation"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#iv-explanation"}},[e._v("#")]),e._v(" IV. Explanation")]),e._v(" "),a("h4",{attrs:{id:"current-logging-behaviour-of-meilisearch-0-20"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#current-logging-behaviour-of-meilisearch-0-20"}},[e._v("#")]),e._v(" Current Logging behaviour of MeiliSearch (0.20)")]),e._v(" "),a("p",[e._v("MeiliSearch uses the rust lib "),a("code",[e._v("env_logger")]),e._v(" to output logs based on the log level fetched from the "),a("code",[e._v("RUST_LOG")]),e._v(" environment variable. "),a("code",[e._v("env_logger")]),e._v(" allows to define a specific log level per module if necessary. "),a("a",{attrs:{href:"https://docs.rs/env_logger/0.8.3/env_logger/",target:"_blank",rel:"noopener noreferrer"}},[e._v("See more here"),a("OutboundLink")],1),e._v(".")]),e._v(" "),a("h4",{attrs:{id:"logging-behaviour-for-milli-0-21"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#logging-behaviour-for-milli-0-21"}},[e._v("#")]),e._v(" Logging behaviour for Milli (0.21)")]),e._v(" "),a("p",[e._v("We have decided to keep using the rust lib "),a("code",[e._v("env_logger")]),e._v(" for Milli/Transplant. However, we will make some changes to make the logging more consistent and versatile.")]),e._v(" "),a("p",[e._v("Instead of using "),a("code",[e._v("RUST_LOG")]),e._v(", we create a "),a("code",[e._v("MEILI_LOG_LEVEL")]),e._v(" environment variable that corresponds to "),a("code",[e._v("RUST_LOG")]),e._v(" in the binary to improve its meaning and clarity to users. A CLI option "),a("code",[e._v("--log-level")]),e._v(" will also be added to follow our configuration convention.")]),e._v(" "),a("h5",{attrs:{id:"log-levels"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#log-levels"}},[e._v("#")]),e._v(" Log Levels")]),e._v(" "),a("table",[a("thead",[a("tr",[a("th",[e._v("Level")]),e._v(" "),a("th",[e._v("Description")])])]),e._v(" "),a("tbody",[a("tr",[a("td",[e._v("ERROR")]),e._v(" "),a("td",[e._v("Everything related to an error. A non blocking error has occured.")])]),e._v(" "),a("tr",[a("td",[e._v("WARN")]),e._v(" "),a("td",[e._v("Used to warn about an exceptional non-blocking event occurring.")])]),e._v(" "),a("tr",[a("td",[e._v("INFO")]),e._v(" "),a("td",[e._v("Default Log Level. It displays high level informations of events occuring in the search engine.")])]),e._v(" "),a("tr",[a("td",[e._v("DEBUG")]),e._v(" "),a("td",[e._v("Used for debugging and development purposes.  More verbose than INFO.")])]),e._v(" "),a("tr",[a("td",[e._v("TRACE")]),e._v(" "),a("td",[e._v("Display everything happening at engine level. Can be useful for rust developers dealing with complex issues")])]),e._v(" "),a("tr",[a("td",[e._v("OFF")]),e._v(" "),a("td",[e._v("Disable the logs.")])])])]),e._v(" "),a("h5",{attrs:{id:"log-format"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#log-format"}},[e._v("#")]),e._v(" Log Format")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('[2021-03-02T20:33:09Z INFO actix_web::middleware::logger] 172.17.0.1:57220 "POST /indexes/indexUID/documents HTTP/1.1" 202 14 "-" "PostmanRuntime/7.26.10" 0.023529\n')])])]),a("h6",{attrs:{id:"mandatory-log-format-part-e-g-time-format-log-level-module-part"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mandatory-log-format-part-e-g-time-format-log-level-module-part"}},[e._v("#")]),e._v(" Mandatory log format part. E.g [TIME_FORMAT LOG_LEVEL MODULE] part.")]),e._v(" "),a("ul",[a("li",[e._v("Time when the request was started to process (in rfc3339 format)")]),e._v(" "),a("li",[e._v("Log levels are  "),a("code",[e._v("ERROR")]),e._v(", "),a("code",[e._v("WARN")]),e._v(", "),a("code",[e._v("INFO")]),e._v(", "),a("code",[e._v("DEBUG")]),e._v(", "),a("code",[e._v("TRACE")]),e._v(", "),a("code",[e._v("OFF")]),e._v(".")]),e._v(" "),a("li",[e._v("The module part gives information about the module that records the log.")])]),e._v(" "),a("h6",{attrs:{id:"http-call"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#http-call"}},[e._v("#")]),e._v(" HTTP Call")]),e._v(" "),a("p",[e._v("Transplant uses "),a("code",[e._v("actix_web::middleware::logger")]),e._v(" to record information about the API endpoints that receive calls.")]),e._v(" "),a("p",[e._v("Given\n"),a("code",[e._v('172.17.0.1:57220 "POST /indexes/indexUID/documents HTTP/1.1" 202 14 "-" "PostmanRuntime/7.26.10" 0.023529')])]),e._v(" "),a("ul",[a("li",[e._v("Peer IP address (or IP address of reverse proxy if used)")]),e._v(" "),a("li",[e._v("First line of request (Example: GET /test HTTP/1.1)")]),e._v(" "),a("li",[e._v("Response status code")]),e._v(" "),a("li",[e._v("Size of response in bytes, including HTTP headers")]),e._v(" "),a("li",[e._v("User-Agent")]),e._v(" "),a("li",[e._v("Time taken to serve the request, in seconds to 6 decimal places")])]),e._v(" "),a("blockquote",[a("p",[e._v("At DEBUG log level, the search endpoint must log the request body and the response body.")])]),e._v(" "),a("h3",{attrs:{id:"v-impact-on-documentation"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#v-impact-on-documentation"}},[e._v("#")]),e._v(" V. Impact on Documentation")]),e._v(" "),a("p",[e._v("The documentation only mentions the logging behavior for the "),a("code",[e._v("development")]),e._v(" env on the "),a("code",[e._v("MEILI_ENV")]),e._v(" part.")]),e._v(" "),a("p",[e._v("We should explain how to specify the logging level using the "),a("code",[e._v("MEILI_LOG_LEVEL")]),e._v(" environment variable and display the logging level table as information in a dedicated section. It should also mention the usage of the cli flag "),a("code",[e._v("--log-level")]),e._v(".")]),e._v(" "),a("h3",{attrs:{id:"vi-impact-on-sdks"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#vi-impact-on-sdks"}},[e._v("#")]),e._v(" VI. Impact on SDKs")]),e._v(" "),a("p",[e._v("N/A")]),e._v(" "),a("h2",{attrs:{id:"_2-technical-aspects"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-technical-aspects"}},[e._v("#")]),e._v(" 2. Technical Aspects")]),e._v(" "),a("p",[e._v("N/A")]),e._v(" "),a("h2",{attrs:{id:"_3-future-possibilities"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-future-possibilities"}},[e._v("#")]),e._v(" 3. Future Possibilities")]),e._v(" "),a("ul",[a("li",[e._v("Store logs on filesystem (give us future possibilites of rolling strategy). We will keep an eye on https://roadmap.meilisearch.com/c/81-specify-log-path, Github issues and, Slack Community messages. Keep in mind that it is possible to send logs to files using "),a("code",[e._v("syslog")]),e._v(" or "),a("code",[e._v("systemd")]),e._v(" journalctl.")]),e._v(" "),a("li",[e._v("Develop an API endpoint to search for logged events and configure the logging policy for the instance (SaaS feature in mind).")]),e._v(" "),a("li",[e._v("Add syntactic sugar helper flag like "),a("code",[e._v("-v, -vv, -vvv")]),e._v(" that can be translated to a "),a("code",[e._v("MEILI_LOG_LEVEL")]),e._v(" value.")]),e._v(" "),a("li",[e._v("Use the rust clone of "),a("code",[e._v("log4j2")]),e._v(", "),a("a",{attrs:{href:"https://docs.rs/log4rs/1.0.0/log4rs/",target:"_blank",rel:"noopener noreferrer"}},[a("code",[e._v("log4rs")]),a("OutboundLink")],1),e._v(" instead of "),a("code",[e._v("env_logger")]),e._v(" to provide the same kind of options that Elasticsearch propose.")])]),e._v(" "),a("h2",{attrs:{id:"_4-planned-changes"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-planned-changes"}},[e._v("#")]),e._v(" 4. Planned Changes")]),e._v(" "),a("h3",{attrs:{id:"_0-21"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_0-21"}},[e._v("#")]),e._v(" 0.21")]),e._v(" "),a("h4",{attrs:{id:"core"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#core"}},[e._v("#")]),e._v(" Core")]),e._v(" "),a("ul",[a("li",[e._v("Use a consistent method to log (relative to internal implementation).")]),e._v(" "),a("li",[e._v("Log output should start with the mandatory log format part.")]),e._v(" "),a("li",[e._v("The HTTP logs should be logged as described in this spec.")]),e._v(" "),a("li",[e._v("The users should be able to choose the log level by filling the "),a("code",[e._v("MEILI_LOG_LEVEL")]),e._v(" environment variable or using the CLI option "),a("code",[e._v("--log-level")]),e._v(".")]),e._v(" "),a("li",[e._v("If log level is set to "),a("code",[e._v("DEBUG")]),e._v(", the "),a("code",[e._v("/search")]),e._v(" endpoint should output request parameters and body response as a log output.")]),e._v(" "),a("li",[e._v("Logs should be displayed in production environment as in development environment, e.g. the default log level is INFO")]),e._v(" "),a("li",[e._v("Milli only display logs from "),a("code",[e._v("DEBUG")]),e._v(" to "),a("code",[e._v("TRACE")]),e._v(" log level.")])]),e._v(" "),a("h4",{attrs:{id:"documentation"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#documentation"}},[e._v("#")]),e._v(" Documentation")]),e._v(" "),a("ul",[a("li",[e._v("Add a dedicated logging section in the documentation.")]),e._v(" "),a("li",[e._v("Add a link to this dedicated section on the "),a("code",[e._v("environment")]),e._v(" "),a("a",{attrs:{href:"https://docs.meilisearch.com/reference/features/configuration.html#environment",target:"_blank",rel:"noopener noreferrer"}},[e._v("section"),a("OutboundLink")],1),e._v(".")]),e._v(" "),a("li",[e._v("We should add the default level for the production environment on the "),a("code",[e._v("environment")]),e._v(" section, by default its "),a("code",[e._v("INFO")]),e._v(".")])])])}),[],!1,null,null,null);t.default=s.exports}}]);